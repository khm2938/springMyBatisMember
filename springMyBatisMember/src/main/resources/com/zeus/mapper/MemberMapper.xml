<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zeus.mapper.MemberMapper">

  <resultMap id="memberMap" type="Member">
    <id property="no" column="no"/>
    <result property="id" column="id"/>
    <result property="pw" column="pw"/>
    <result property="name" column="name"/>
    <result property="regDate" column="regdate"/>
    <collection property="authList" resultMap="authMap"/>
  </resultMap>

  <resultMap id="authMap" type="MemberAuth">
    <result property="no" column="no"/>
    <result property="auth" column="auth"/>
  </resultMap>

  <select id="read" resultMap="memberMap">
    SELECT m.no,
           m.id,
           m.pw,
           m.name,
           m.regdate,
           a.auth
    FROM MYBATISMEMBER m
    LEFT OUTER JOIN MYBATISMEMBERAUTH a
      ON m.no = a.no
    WHERE m.no = #{no}
      AND m.enabled = '1'
  </select>

  <select id="list" resultMap="memberMap">
    SELECT no,
           id,
           pw,
           name,
           regdate
    FROM MYBATISMEMBER
    WHERE enabled = '1'
    ORDER BY regdate DESC
  </select>

  <select id="search" resultType="Member">
    SELECT *
    FROM MYBATISMEMBER
    <where>
      enabled = '1'
      <if test="keyword != null and keyword != ''">
        <choose>
          <when test="searchType == 'id'">
            AND id LIKE '%' || #{keyword} || '%'
          </when>
          <when test="searchType == 'name'">
            AND name LIKE '%' || #{keyword} || '%'
          </when>
          <otherwise>
            AND name LIKE '%' || #{keyword} || '%'
          </otherwise>
        </choose>
      </if>
    </where>
    ORDER BY no DESC
  </select>

  <update id="update">
    UPDATE MYBATISMEMBER
    SET name = #{name},
        pw   = #{pw}
    WHERE no = #{no}
      AND enabled = '1'
  </update>

  <update id="delete">
    UPDATE MYBATISMEMBER
    SET enabled = '0'
    WHERE no = #{no}
  </update>

  <delete id="deleteAuth">
    DELETE FROM MYBATISMEMBERAUTH
    WHERE no = #{no}
  </delete>

  <insert id="create" parameterType="Member">
    <selectKey keyProperty="no" resultType="int" order="BEFORE">
      SELECT mybatismember_seq.NEXTVAL FROM DUAL
    </selectKey>

    INSERT INTO MYBATISMEMBER (no, id, pw, name, regdate, enabled)
    VALUES (#{no}, #{id}, #{pw}, #{name}, SYSDATE, '1')
  </insert>

  <insert id="createAuth">
    INSERT INTO MYBATISMEMBERAUTH (no, auth)
    VALUES (#{no}, #{auth})
  </insert>

</mapper>
